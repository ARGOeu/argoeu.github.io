<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>Sync compoments | ARGO</title>
  <link rel="alternate" type="application/atom+xml" title="API Changes" href="/changes.atom" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <link rel="icon" href="/shared/favicon.ico">
  <!-- Bootstrap core CSS -->
  <link href="/shared/css/bootstrap.min.css" rel="stylesheet">
  
  <link rel="stylesheet" href="/shared/css/font-awesome.min.css">
  <link rel="stylesheet" href="/shared/css/font-beba.css">

  <link href="/shared/css/custom.css" rel="stylesheet">
  <script src="/shared/js/ie-emulation-modes-warning.js"></script>

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>

<body class="api">
  <!-- Fixed navbar -->
<nav class="navbar navbar-inverse navbar-fixed-top">
	<div class="container">
		<div class="navbar-header">
		  <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
		    <span class="sr-only">Toggle navigation</span>
		    <span class="icon-bar"></span>
		    <span class="icon-bar"></span>
		    <span class="icon-bar"></span>
		  </button>
		  <a class="navbar-brand" href="#"><img src='/shared/images/argo-logo.png' alt='Argo'  /></a>
		</div>
		<div id="navbar" class="navbar-collapse collapse">
		  <ul class="nav navbar-nav navbar-right">
		    <li class="active"><a href="/index.html#">Home</a></li>
		    <li><a href="/index.html#what">About</a></li>
		    <li><a href="/index.html#features">Features</a></li>
		    <li><a href="/use-cases/">Use cases</a></li>
		    <li class="dropdown">
		      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Documentation <span class="caret"></span></a>
		      <ul class="dropdown-menu" role="menu">
			<li><a href="/overview/"><i class="fa fa-file-text-o"></i>  Overview</a></li>
			<li><a href="/guides/installation/"><i class="fa fa-file-text-o"></i>  Installation</a></li>
			<li><a href="/guides/sync/"><i class="fa fa-refresh"></i > Sync components</a></li>
			<li><a href="/guides/poem/"><i class="fa fa-check-square-o"></i>  Poem service</a></li>
			<li><a href="/guides/consumer/"><i class="fa fa-send-o"></i>  Consumer</a></li>
			<li><a href="/guides/compute/"><i class="fa fa-cog"></i>  Compute Engine</a></li>
			<li><a href="/guides/webui/"><i class="fa fa-connectdevelop"></i>  Web UI</a></li>
			<li class="divider"></li>
			<li class="dropdown-header">Developers</li>
			<li><a href="/guides/api/"><i class="fa fa-cogs"></i>  API </a></li>
			<li><a href="#"><i class="fa fa-github-alt"></i>  Github</a></li>
		      </ul>
		    </li>
		  </ul>
		</div><!--/.nav-collapse -->
	</div><!--container-->
</nav>

  <div class='container-fluid' >
    <div class='row'>
        <div class="col-md-2 sidebar">
                   <div class="list-group">	
            <a class="list-group-item disabled blue" href="#">Documentation</a>
          
            <a class="list-group-item" href="/overview/">Overview</a>
          
          
            <a class="list-group-item" href="/guides/installation/">Installation</a>
          
            <a class="list-group-item disabled blue" href="#">Components</a>
          	
            <a class="list-group-item active" href="/guides/sync/"><i class="fa fa-refresh"></i> Sync components</a>
          
          
            <a class="list-group-item" href="/guides/poem/"><i class="fa fa-check-square-o"></i> Poem service</a>
          
          
            <a class="list-group-item" href="/guides/consumer/"><i class="fa fa-send-o"></i> Consumer</a>
          
            
            <a class="list-group-item " href="/guides/compute/"><i class="fa fa-cog"></i> Compute Engine</a>
          
          
            <a class="list-group-item" href="/guides/api/" >
          
          <i class="fa fa-cogs"></i> API</a>
          
            <a class="list-group-item" href="/guides/webui/"><i class="fa fa-connectdevelop"></i> Web UI</a>
          
          </div> <!--list group-->

        </div>
        <div class="col-md-8 main">
          	
            <h1 class="highlight">
            
              <i class='fa fa-refresh'></i> 
            
            Sync compoments</h1>
          
          <p class="lead"> This document describes the sync components.</p>
          
<h2 id="poem-profiles-sync">Poem profiles sync</h2>

<p>The poem profiles sync download the current poem profiles and stores them to a file.</p>

<p>There are five (5) config files:</p>

<ul>
  <li>
<code>/etc/ar-sync/poem.conf</code>,</li>
  <li>
<code>/etc/ar-sync/poem-profile.conf</code>,</li>
  <li>
<code>/etc/ar-sync/poem-server.conf</code>,</li>
  <li>
<code>/etc/ar-sync/poem-sync.conf</code> and</li>
  <li><code>/etc/ar-sync/poem-customer.conf</code></li>
</ul>

<p>This application requires host certificates and expects the certificate file to be installed at:
<code>/etc/grid-security/hostkey.pem</code>
<code>/etc/grid-security/hostcert.pem</code></p>

<p>The <code>/etc/ar-sync/poem.conf</code> config should look like this:</p>

<pre><code>snf-624922.vm.okeanos.grnet.gr;ops
</code></pre>

<p>Each line in the <code>/etc/ar-sync/poem.conf</code> file defines a poem server from which to load profiles and a list of VOs to define which profiles are used.</p>

<p>In the default configuration profiles are loaded from one poem server: <code>mon.egi.eu</code>, and only ops VO’s profile are used.</p>

<p>The <code>/etc/ar-sync/poem-profile.conf</code> config file looks like this:</p>

<pre><code>CH.CERN.SAM.ROC
CH.CERN.SAM.ROC_OPERATORS
CH.CERN.SAM.ROC_CRITICAL
CH.CERN.SAM.OPS_MONITOR
CH.CERN.SAM.OPS_MONITOR_CRITICAL
CH.CERN.SAM.GLEXEC
CH.CERN.SAM.CLOUD-MON
</code></pre>

<p>Each line in the <code>/etc/ar-sync/poem-profile.conf</code> file defines full name of filtered profiles list. So the list of profiles loaded form the servers are filtered according to this list.</p>

<p>The <code>/etc/ar-sync/poem-server.conf</code> config file looks like this:</p>

<pre><code>URL=http://mon.egi.eu/nagios-roles.conf;ch.cern.sam.ROC,ch.cern.sam.ROC_OPERATORS,ch.cern.sam.ROC_CRITICAL,ch.cern.sam.GLEXEC
ALL:opsmon.egi.eu;ch.cern.sam.OPS_MONITOR,ch.cern.sam.OPS_MONITOR_CRITICAL
ALL:cloudmon.egi.eu;ch.cern.sam.CLOUD-MON
</code></pre>

<p>The <code>/etc/ar-sync/poem-sync.conf</code> file contains all the information regarding the configurations themselves:</p>

<pre><code>poemFile = '/etc/ar-sync/poem.conf'
poemProfileFile = '/etc/ar-sync/poem-profile.conf'
poemServerFile = '/etc/ar-sync/poem-server.conf'
poemRequest = '%s/poem/api/0.2/json/metrics_in_profiles/?vo_name=%s'
hostKey = '/etc/grid-security/hostkey.pem'
hostCert = '/etc/grid-security/hostcert.pem'

outputDir = '/var/lib/ar-sync'
avroOutputDir = '/var/lib/ar-sync'
avroOutputSchema = '/etc/ar-sync/metric_profiles.avsc'
</code></pre>

<p>Finally, <code>/etc/ar-sync/poem-customer.conf</code> file defines customers, their jobs and directory structure that will be created:</p>

<pre><code>[DIR]
OutputDir = /var/lib/ar-sync

[CUSTOMER_EGI]
Jobs = JOB_Critical, JOB_Cloudmon

[JOB_Critical]
Profiles = ROC_CRITICAL

[JOB_Cloudmon]
Profiles = CLOUD-MON
</code></pre>

<p>It’s a INI file with key, value pairs and sections. Each customer is represented with <code>[CUSTOMER_name]</code> section and set of theirs jobs listed in the <code>Jobs</code> key. Values of <code>Jobs</code> key is a list of <code>[JOB_name]</code> sections that are related to a certain job. Job has its set of keys that are actually attributes of job.</p>

<blockquote>
  <p>Currently, this config file is only <code>poem-sync</code> specific so only POEM Profiles can be specified but the plan is to extend it with the other attributes that refer to other tools from ar-sync package. That means that this config <strong>will not</strong> be only poem-sync specific and it will be read by all other tools from the package.</p>
</blockquote>

<p>The name of directory that will be created in an <code>OutputDir</code> value is the name of customer. Customer name is a string defined in the section name of the customer, after an underscore. So <code>CUSTOMER_EGI</code> will create <code>EGI</code> directory in an <code>OutputDir</code> value. Following the same logic of naming directories, there will be subdirectories created for each job. So <code>JOB_Critical</code> means that there will be <code>Critical</code> directory inside of customer’s EGI directory.</p>

<h2 id="topology-sync">Topology sync</h2>

<p>Topology is abstracted by the two levels of hierarchy:</p>

<ul>
  <li>group of groups</li>
  <li>group of service endpoints</li>
</ul>

<p>Service endpoints are grouped either by the means of Sites or Service groups. Those are listed and represented as an upper level entity of an endpoints - group of groups. Customer can fetch either Sites and their corresponding endpoints or Service groups and their corresponding endpoints per job, but not both of them. Set of tags for further filtering of group of groups is different for Sites and Service groups so it depends on what kind of group of endpoints is being fetched. In contrary, set of tags for groups of endpoints remains the same no matter what type of fetch customer specified. </p>

<p><code>topology-sync</code> can take config file as an argument and is run per customer’s job.</p>

<p>Example of <code>topology-sync.conf</code>:</p>

<pre><code>[FetchType]
ServiceGroups = True

[HostCertificate]
hostKey = /etc/grid-security/hostkey.pem
hostCert = /etc/grid-security/hostcert.pem

[OutputDir]
outputDir = /var/lib/ar-sync/
avroOutputDir = /var/lib/ar-sync/EGI/Cloudmon

[AvroSchemas]
avroOutputGroupOfGroupsSchema = /etc/ar-sync/group_groups.avsc
avroOutputGroupOfServicesSchema = /etc/ar-sync/group_services.avsc
avroOutputGroupOfEndpointsSchema = /etc/ar-sync/group_endpoints.avsc

[SelectGroupOfGroups]
Monitored = Y
Scope = Local

[SelectGroupOfServiceEndpoints]
Production = Y
Monitored = Y
Scope = Local
</code></pre>

<p>So, in a FetchType section customer can either specify:</p>

<ul>
  <li>
<code>ServiceGroups = True</code> - to fetch Service groups</li>
  <li>
<code>Sites = True</code> - to fetch Sites</li>
</ul>

<p>Beside tags, all other options and sections are self-explainable.</p>

<h3 id="tags">Tags</h3>

<p>Tags represent a fine-grained control of what is being written in output files. It’s a convenient way of selecting only certain entities, being it Sites, Service groups or Service endpoints based on appropriate criteria. Tags are optional so if a certain tag for a corresponding entity is omitted, than filtering is not done. In that case, it can be considered that entity is fetched for all its values of an omitted tag.</p>

<p>Group of group tags are different for a different type of fetch. Tags and values for a different entities are:</p>

<h4 id="sites">Sites</h4>

<ul>
  <li><code>Certification  = {Certified, Uncertified, Closed, Suspended, Candidate}</code></li>
  <li><code>Infrastructure = {Production, Test}</code></li>
  <li><code>Scope = {EGI, Local}</code></li>
</ul>

<h4 id="servicegroups">ServiceGroups</h4>

<ul>
  <li><code>Monitored = {Y, N}</code></li>
  <li><code>Scope = {EGI, Local}</code></li>
</ul>

<p>Tags for selecting the groups of endpoints are:</p>

<h4 id="service-endpoints">Service Endpoints</h4>

<ul>
  <li><code>Production = {Y, N}</code></li>
  <li><code>Monitored = {Y, N}</code></li>
  <li><code>Scope = {EGI, Local}</code></li>
</ul>

<h2 id="downtime-sync">downtime-sync</h2>

<p>The downtimes sync downloads the scheduled downtimes for defined date and stores them to a file.
This application requires host certificates and expects the certificate file to be installed at: <code>/etc/grid-security/hostkey.pem</code>, <code>/etc/grid-security/hostcert.pem</code></p>

<p>Usage:</p>

<p><code>python downtime_sync -d &lt;date&gt;</code></p>

<p><code>date</code> parameter is the date for which downtimes are downloaded. Format is <code>yyyy-mm-dd</code>.</p>

<p>Configuration is defined in the source file of the application.</p>

<pre><code>gocdbHost = 'goc.egi.eu'
hostKey = '/etc/grid-security/hostkey.pem'
hostCert = '/etc/grid-security/hostcert.pem'

defaultOutputFileDowntimes = outputDir + '/downtimes_%s.out'
# Hostname, Service Type, Start, End
defaultOutputFileDowntimesFieldFormat = '%s\001%s\001%s\001%s\r\n'

outputDir = '/var/lib/ar-sync'
avroOutputDir = '/var/lib/ar-sync'
avroOutputSchema = '/etc/ar-sync/downtimes.avsc'
</code></pre>

<p>The Configuration fields are defined below:</p>

<ul>
  <li>
<code>gocdbHost</code> - This field defines the hostname of the GOCDB server.</li>
  <li>
<code>hostKey</code> - This field defines the path to host certificate key.</li>
  <li>
<code>hostCert</code> - This field defines the path to host certificate.</li>
  <li>
<code>defaultOutputFileDowntimes</code> - This field defines the output file name format. The ‘%s’ tag is for the timestamp.</li>
  <li>
<code>defaultOutputFileDowntimesFieldFormat</code> - This field defines the output file format for downloaded downtimes.</li>
  <li>
<code>outputDir</code> - This field defines the directory path where to log the downloaded downtimes.</li>
  <li>
<code>avroOutputDir</code> - This field defines the directory path where to log the downloaded downtimes in avro binary format.</li>
  <li>
<code>avroOutputSchema</code> - This field defines the structure of the avro variant of downloaded downtimes.</li>
</ul>

<p>Pseudocode of the downtimes sync:</p>

<pre><code>parse input date
get downtimes for date
foreach downtime in downloaded downtimes
    if downtime is 'SCHEDULED' and downtime severity is 'OUTAGE'
        write downtime to log
</code></pre>

<h2 id="prefilter---plaintext-variant">prefilter - plaintext variant</h2>

<p>The prefiltering app loads the list of logged messages and filters the mesages according to downloaded POEM profiles.</p>

<p>Usage:</p>

<p><code>python prefilter -d &lt;date&gt;</code></p>

<p><code>date</code> parameter is the date for which messages are filtered. Format is yyyy-mm-dd.</p>

<p>Configuration is defined in the source file of the application (<code>prefilter</code>).</p>

<pre><code># consumer
consumerFileDirectory = '/var/lib/ar-consumer'
consumerFilename = 'ar-consumer_log_%s-%s-%s.txt'
consumerFileFields = 'timestamp;ROC;nagios_host;metricName;serviceType;hostName;metricStatus;voName;voFqan'
consumerFileFieldDelimiter = '\001'

# poem
poemFileDirectory = '/var/lib/ar-sync'
poemFilename = 'poem_sync_%s_%s_%s.out'
poemFileFields = 'server;ngi;profile;service_flavour;metric;vo;fqan'
poemFileFieldDelimiter = '\001'

# output
outputFileDirectory = '/var/lib/ar-sync'
outputFilename = 'prefilter_%s_%s_%s.out'
outputFileFields = 'timestamp;metricName;serviceType;hostName;metricStatus;voName;voFqan;profile'
outputFileFormat = '%s\001%s\001%s\001%s\001%s\001%s\001%s\001%s\r\n'
</code></pre>

<p>The Configuration fields are defined below:</p>

<ul>
  <li>
<code>consumerFileDirectory</code> - This field defines the path to directory in w hich the message log file from the consumer are stored.</li>
  <li>
<code>consumerFilename</code> - This field defines the consumer log file name format. The %s tag is used for there
timestamp.</li>
  <li>
<code>consumerFileFields</code> - This field defines consumer log entry fields for each message.</li>
  <li>
<code>consumerFileFieldDelimiter</code> - This field defines the message entry delimiter used in the consumer log file.</li>
  <li>
<code>poemFileDirectory</code> - This field defines the path to directory in w hich the POEM profile files (from poem-sync) are stored.</li>
  <li>
<code>poemFilename</code> - This field defines the POEM profile sync log file name format. The %s tag is used for the timestamp.</li>
  <li>
<code>poemFileFields</code> - This field defines POEM profile sync log entry fields for each profile.</li>
  <li>
<code>poemFileFieldDelimiter</code> - This field defines the POEM profile entry delimiter used in the POEM profile sync log file.</li>
  <li>
<code>outputFileDirectory</code> - This field defines the directory path w here to output the filtered messages.</li>
  <li>
<code>outputFilename</code> - This field defines the output file name format. The ‘%s’ tags are used for year month and day (in that order) of the orginal consumer log file.</li>
  <li>
<code>outputFileFields</code> - This field defines the output file fields for each filtered message.</li>
  <li>
<code>outputFileFormat</code> - This field defines the output file format.</li>
</ul>

<p>Pseudocode of the prefilter:</p>

<pre><code>parse input date
load NGIs from poem sync
forach profile in poem sync
    create profile tree
foreach messsage in consmer log file
    if message NGI is in loaded NGIs
        get message server tree from profile tree
        if server tree exists
            get message service flavor tree from server tree
            if service flavor tree exists
                get message service metric tree from service flavor tree
                if service metric tree exists
                    if message vo defined
                        get message vo tree from service metric tree
                        if vo tree exists
                            if message fqan defined
                            get message fqan tree from vo tree
                                if fqan tree exists
                                    set profiles from vo tree
                                else
                                    get profile tree for undefined fqan from vo tree
                                    set profiles from profile tree
                    else
                        get vo tree for undefined vo from service metric tree
                        set profiles from vo tree

    if profiles set
        foreach profile in profiles
            log message to output file
    else
        log message to reject log
</code></pre>

<h2 id="prefilter-avro---avro-variant">prefilter-avro - avro variant</h2>

<p>Most of logic that apply for plaintext prefilter, apply also for the avro variant of it. Though, there are some slight changes in the configuration of it since avro schema now defines the format of the output.</p>

<pre><code># consumer
consumerFileDirectory = '/var/lib/ar-consumer'
consumerFilename = 'ar-consumer_log_%s-%s-%s.avro'

# poem
poemFileDirectory = '/var/lib/ar-sync'
poemFilename = 'poem_sync_%s_%s_%s.out'
poemFileFields = 'server;ngi;profile;service_flavour;metric;vo;fqan'
poemFileFieldDelimiter = '\001'
poemNameMappingFilename = 'poem_name_mapping.cfg'

# output
outputFileDirectory = '/var/lib/ar-sync'
outputFilename = 'prefilter_%s_%s_%s.avro'
outputSchema = '/etc/ar-consumer/metric_data.avsc'

# write to standard output
writeToStd = 0

# reject on missing monitoring host
rejectMissingMonitoringHost = 1

# past files checking
checkInputFileForDays = 1
</code></pre>

        </div><!--col-md-8-->
        <div class="col-md-2">&nbsp;</div>
      </div><!--row-->
    </div><!--container fluid-->
    <!-- from -->
<div class="jumbotron">
    <div class="container" style='padding-left:40px;'>
      <a href='https://www.grnet.gr/en' target='blank'><img src='/shared/images/grnet_transparent.png' style='padding-left:40px;' alt='GRNET S.A - Greek Research & Technology Network' title='GRNET S.A - Greek Research & Technology Network'/></a>
      <a href='http://www.cnrs.fr/' target='blank'><img src='/shared/images/cnrs.png' style='padding-left:40px;' alt='Centre national de la recherche scientifique' title='Centre national de la recherche scientifique'/></a>
      <a href='http://www.srce.unizg.hr/en/' target='blank'><img src='/shared/images/srce.png' style='padding-left:40px;' alt='SCRE - Web stranice Sveučilišnog računskog centra' title='SCRE - Web stranice Sveučilišnog računskog centra'/></a>
      <a href='http://www.egi.eu' target='blank'><img src='/shared/images/egi2.png' style='padding-left:40px;margin-top:-20px;' alt='European Grid Infrastructure' title='European Grid Infrastructure'/></a>
    </div> <!-- /container -->
</div> <!-- jumbotron -->
<!-- from-->


  
<!--footer -->
    <footer  id="footer" class="footer">
	<div class='footer_top'>       
	<div class="row ">
       </div>
       <div class="row ">
	
        <div class=" col-md-offset-1 col-md-3">
		<p><img src='/shared/images/argo-logo.png' alt='Argo'  /></p>		
		<p>ARGO is a lightweight service for Service Level Monitoring designed for medium and large sized e-Infrastructures. </p>
   	</div>
	 <div class="col-md-offset-1 col-md-3">
		<h4>Contact Us</h4>
		<address>
 		<strong>Email</strong><br>
      <a href="mailto:argoeu-project@googlegroups.com" style='color:white;'>argoeu-project[AT]googlegroups.com</a>
		</address>
   	</div>
 	<div class="col-md-3">
		<h4>Open development </h4>
    <p> We follow an open development process. All the repositories of ARGO are hosted on Github under the ARGOeu organization.</p>
   	</div>
    <div class="col-md-1"></div>
      </div>
      </div><!--footer_top-->
      <div class="footer_bottom_holder">
	<div class="footer_bottom">
    <div class="textwidget"><span>Copyright &copy; 2014 - 2015 GRNET S.A. </span>
    </div>
  <div class="textwidget"><span>
      <a href='http://validator.w3.org/check?uri=referer' target='blank'>
        <img src='/shared/images/validated.png' alt='HTML5 - CSS3 - W3C Validated' title='HTML5 - CSS3 - W3C Validated' height="30"/>
       </a>
    </span>
  </div>
	</div>
     </div>	
    </footer>
<!--/footer -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/shared/js/jquery.min.js"></script>
    <script src="/shared/js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="/shared/js/ie10-viewport-bug-workaround.js"></script>
      <script src="/shared/js/jquery.easing.1.3.js"></script>
  <script src="/shared/js/jquery.animate-enhanced.min.js"></script>
  <script src="/shared/js/jquery.superslides.min.js" type="text/javascript" charset="utf-8"></script>
  <script>
    $(function() {
    

      $('#slides').superslides({
        hashchange: false,
        play: 10000
      });

    });
  </script>

</body>
</html>
